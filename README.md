copy and update from transformer-master
